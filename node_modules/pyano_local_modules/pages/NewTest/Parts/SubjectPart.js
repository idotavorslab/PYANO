// **pages/NewTest/Parts/SubjectPart.js
const $ = require('jquery');
let PyFns = () => require("pyano_local_modules/pages/NewTest/PyFns");
let { EStore } = require("pyano_local_modules/ext_libs");
let { bool } = require("pyano_local_modules/util");
let StoreFns = () => require("pyano_local_modules/pages/NewTest/StoreFns");
let Gui = require("pyano_local_modules/pages/NewTest/Gui");
let Swal = require('sweetalert2');

/**@param {boolean} inputMissing*/
function reset({ inputMissing }) {
	if (inputMissing) {
		$inputDiv.addClass('input-missing');
	}

	$submitSubjectBtn
		.addClass('inactive-btn')
		.removeClass('active-btn')
		.html('Submit');

	$autocompleteSpan.text('Subject Id');
	$editableSpan.text('');
}

function autoComplete() {
	let subjectIdInputVal = $editableSpan.text().lower();


	if (!bool(subjectIdInputVal)) {
		reset({ inputMissing: true });
	} else {
		// autocomplete

		let autocomplete = subjects.find(s => s.startsWith(subjectIdInputVal));
		$inputDiv.removeClass('input-missing');
		$submitSubjectBtn
			.removeClass('inactive-btn')
			.addClass('active-btn')
			.html(subjectIdInputVal);
		$autocompleteSpan
			.text(autocomplete
			      ? autocomplete.substr(subjectIdInputVal.length)
			      : '');
		Swal.close();
	}
}

let subjects = EStore.get('subjects');
let $Div = $('<div id="subject_div">');
let $editableSpan = $('<span class="input-div-editable-span">')
	.attr('contenteditable', true)
	.on('input', autoComplete);

let $autocompleteSpan = $('<span class="input-div-autocomplete-span">')
	.text('Subject Id');

let $inputDiv = $('<div class="input-div" id="subject_id_input_div">')
	.click(() => { $editableSpan.focus(); })
	.keydown(e => {
		// Tab
		if (e.which == 9) {
			let value = $editableSpan.text() + $autocompleteSpan.text();
			$editableSpan.text(value);
			$autocompleteSpan.text('');
			$submitSubjectBtn.html(value);
		} // Todo: if escape clear autocomplete
	})
	.append(
		$('<div class="input-div-inner-container">')
			.append($editableSpan,
				$autocompleteSpan)
	);

let $submitSubjectBtn = $('<button id="subject_submit_subject_btn">')
	.addClass('my-btn inactive-btn')
	.html('Submit')
	.click(async () => {
		let subjectIdInputVal = $editableSpan.text().lower();
		let ok = Gui.toggleInputDiv($inputDiv, { bad: !bool(subjectIdInputVal) });
		if (ok)
			PyFns().checkCreateNewSubject(subjectIdInputVal);
		reset({ inputMissing: false });
		StoreFns().setCurrentSubject(subjectIdInputVal, { updateSubjects: true });
		Gui.setCurrentSubjectSubtitle(subjectIdInputVal);
		let subjectsList = await PyFns().getSubjectDirsNames();
		StoreFns().setSubjects(subjectsList, { nullifyCurrentIfNotInList: true });

	});


$Div.append(
	$submitSubjectBtn,
	$inputDiv
);

module.exports = { $Div };
