// **pages/NewTest/newtest.js

let { EStore } = require("pyano_local_modules/ext_libs");
let { safeSwitchCss, $MainContent, $Sidebar } = require("pyano_local_modules/document");
let PyFns = require("./PyFns");
// let Elements = require("./Elements");
let Gui = require("./Gui");
let { SubjectPart, LevelsPart, SettingsPart } = require("./Parts/parts");


/**@param {TLearningType} mode*/
function _toMode(mode) {
	SettingsPart.toMode(mode);
	LevelsPart.toMode(mode);
}

const newTestPage = {

	/**@param {boolean} reload*/
	switch: async reload => {
		EStore.set({ last_page: 'new_test', 'current_test.finished_trials_count': 0 });
		if (reload)
			return reloadPage();

		await asx.$fadeOutMany(100, $Sidebar, $MainContent);
		$MainContent.empty();
		$MainContent.on({
			'dragover dragenter': e => {
				e.preventDefault();
				e.stopPropagation();
			},
			'drop': async e => await require("./DragDrop").onDrop(e)
		});
		require("pyano_local_modules/sidebar").to_new_test();
		safeSwitchCss("templates/css/new_test.css");
		const truth = EStore.truth();
		const numOfNotes = truth.numOfNotes();
		Gui.setTruthFileSubtitle(truth, numOfNotes);
		let subjectsList = await PyFns.getSubjectDirsNames();
		$MainContent.append(
			Gui.$subtitle,
			SubjectPart.$Div,
			SettingsPart.$Div,
			LevelsPart.$Div,
			Gui.$readySaveLoadSaveas(),
		);
		EStore.set('subjects', subjectsList);
		if (!(subjectsList.includes(EStore.subjectName())))
			EStore.set('current_test.current_subject', null);
		// require("./StoreFns").setSubjects(subjectsList, { nullifyCurrentIfNotInList: true });
		const learningType = EStore.currentTest().learning_type;
		_toMode(learningType);

		SettingsPart.learningType.setClickFn(e => {
			const accuracyClicked = e.currentTarget.id == SettingsPart.learningType.firstOpt.id;
			if (accuracyClicked)
				_toMode("accuracy");
			else
				_toMode("tempo");
		});
		await asx.$fadeInMany(300, $Sidebar, $MainContent);
	}

};
module.exports = newTestPage;
